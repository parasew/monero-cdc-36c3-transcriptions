# Jeremy Rand

_**Critical Decentralisation Cluster 36c3 - Adventures and Experiments Adding Namecoin to Tor Browser**_

[youtu.be/7C6x0Duql5U](https://youtu.be/7C6x0Duql5U)

_**Abstract**_

The Namecoin and Tor developers are running a new experiment: the GNU/Linux Nightly Builds of Tor Browser now have optional support for resolving Namecoin's .bit domains. This experiment aims to provide a fix for the long-standing UX problem with .onion domains: the lack of human-meaningful names. With Namecoin, you can access onion services via nice, memorable addresses like http://federalistpapers.bit/ instead of http://7fa6xlti5joarlmkuhjaifa47ukgcw... . In this talk, I'll cover the goals of the experiment, the work that went into getting here, and the work that remains to be done.

_**Transcription**_

_Diego:_ Jeremy is gonna come up here and he's gonna talk with us about rent Namecoin. So I'm gonna invite him up, and directly after this talk he is going to have a workshop of his own, which is probably gonna take place in the workshop area, where he's going to just demonstrate to you everything that he's gonna be talking about. So go ahead, come on out, let's go and give him a hand. He’s gonna talk with us about Namecoin,  Tor… hand, yeah, hand. Ok, ok, here we go. And yeah Jeremy take away.

_Jeremy:_ All right. I'm Jeremy from Namecoin. So today I'm gonna be talking about some adventures that I had over the past year or so integrating a Namecoin into Tor Browser and experimenting with all that cool stuff. So let's get started shall we.

So first of a bit of a disclaimer: this is not a Tor project talk. I'm a Namecoin developer, that is going to color my perspective to some extent. So the perspective that the Tor developers might differ for mine and that's just totally ok.

All right, so as we probably all know here .onion services with Tor are really really cool. They have encryption, they have authentication, they have censorship resistance — all this stuff is really awesome. And it doesn't even depend on a trusted third party like certificate authorities, it's just magically built-in. So they're great. Unfortunately the UX has a problem. What is this problem you ask? Well this is the problem.

Addresses, like this are basically impossible for humans to remember or even reliably recognize. And so as a result humans do not actually check the entire address, and so this can cause things like phishing attacks.

So for anyone who is not here at the intro to Namecoin talk yesterday, I will give a very brief intro. Namecoin is basically DNS but on a blockchain. We use the .bit top-level domain. Internally the names are represented by special coins, you can think of the sort of light colored coins. We were the first project forked from Bitcoin all the way back in 2011.

So the Namecoin developers recognized very early on that using Namecoin as a naming layer for .onion services was a potentially very interesting use case, because this would provide global decentralized names just like .onion, but they would also be human meaningful. For example is something like I don't know federalistpapers.bit could point to the Federalist Papers .onion service, and this would solve that UX issue.

The first implementation of all this stuff was all the way back in July of 2011. It was NmcSocks by itsnotlupus. And these experiments continued for quite a few years. We had some discussions with the Tor developers, there wasn't a huge amount of adoption that actually materialized. I gave a 34C3 talk on a lot of this background, check it out if you're curious.

But then we started seeing some signs that there might be some increased interest, and this happened because I happened to run into a Tor Browser developer, Arthur Edelstein, in October of last year on Twitter, and this is all I all that happened, was I subscribe to an RSS feed of all the Twitter search results for Namecoin to see what people are saying about us, and I happened to see this. Not sure if you can read that. So Arthur is saying: “I'm interested in making onion sites easier to use by making the domain names memorable. Different approaches have different properties which I’m trying to explore’. And he mentions Namecoin is a potentially interesting approach. So I replied, I said: “Hi, I'm the Namecoin dev who prototyped Namecoin naming for onion services. Definitely still interested, would be cool to chat about moving forward’.

Now the discussion that got kicked off there was interesting and different from previous discussions, because previously the Tor people had mostly been interested in helping users experiment with installing Namecoin editor browser themselves. This was the motivation of the “Proposal 279” pluggable naming API. But this time Arthur had a sort of different intended approach, he said: “I think modularity is good, but I don't think waiting for the “sands of time” to pick a winner is the right approach. Instead Tor project should start implementing and deploying resolvers in Tor and Tor Browser, and then we can learn and iterate”.

So something that initially surprised me, when I started talking to Tor people about this topic, was that so the Tor people totally recognized that the non-meaningful names of .onion domains were a massive UX problem and a massive security problem. To the point that the Tor people are generally ok with compromising on the security model to fix it. And in particular that means that making sure that the name owners stay anonymous is actually not really a requirement, at least short term you know. I mean they want to make sure we have a plan to deal with it eventually, but this was not something they were going to be strict about short term.

The big thing they were going to be fairly strict about was performance and scalability. So for example Arthur gave sort of a recommended scenario for what his requirements would be, that he would suggest, which is the user installs a Tor Browser from scratch and they've launched it, and then they immediately type a .bit domain into the address bar, and the delay in loading the website it shouldn't be noticeably more than what you would expect to get from a .onion website, meaning that the random variation in terms of just building a Tor circuit to the .onion service that should be the dominant part of the delay. Sound difficult? Yeah.

When he said that, my initial thought was: “Ok, there is no way we're going to be able to pull that off”. But you know what I didn't say that, what I said was: “Ok, that's gonna be really hard, but you know there are a lot of optimizations we could be doing that we're not doing right now. So you know let me do some experiments we'll see, what we can pull off”. And you know just a general rule when you're a software developer, don't tell people on the spot that something is going to be impossible, at least, you know do a little bit of basic research before you say that.

So during this time Ahmed Bodiwala and I were being funded by a NLnet and Cyphrs to port Electrum, the lightweight Bitcoin wallet, to Namecoin. And that port was, it was very very recent, when Arthur and I first started talking about this Tor stuff, and but despite the fact that Electrum-NMC was very very immature and embryonic at that time, after talking to Arthur it became really clear that that code base was going to be our best bet for achieving the performance needs that Arthur outlined.

So NLnet had actually allocated a bunch of funding for us to spend on a different lightweight client which was called ConsensusJ-Namecoin. And based on talking to Arthur it looked like that was going to be a dead end for us, because that design was going to have a five minute initial sync, and there was no way we could really optimize that anymore. So happily NLnet is totally ok with letting us divert funding from one set of deliverables to another. So we decided to divert that funding from ConsensusJ-Namecoin to focus on getting Electrum-NMC to the point where Tor might be able to use it. So kudos to NLnet for actually giving us that flexibility, it's super cool.

All right. So what were we starting with in October of 2018 before we did optimizations for this. Well the initial syncup downloaded 672 megabytes which took around six minutes on my Talos II workstation, which is a very fast CPU, and that was without Tor. So and all that had to be done before you could do any name lookups. So we were a very far away from actually meeting the performance goal that Arthur outlined.

For anyone who's not familiar with how Electrum for Bitcoin encodes checkpoints. Basically it's a list of every 2016th block hash. And Electrum only downloads the headers for the blockchain that are after the final checkpoint hash that it has. And this is useful because if you um… usually you create a wallet that that is created after the final checkpoint, so this way it doesn't need to download any block headers that are before the checkpoint, and those not gonna be needed anyway, because they're not going to cover your wallets. But if you do this, if you do need to validate a transaction that's before the last checkpoint hash, then Electrum will just download all 2016 block headers between the two checkpoint hashes that surround it, and then it will validate the transaction using SPV.

But this doesn't work great for Namecoin and here's why. Unexpired names can be anywhere in the last 36 kiloblocks, which means even if a wallet was created after the final checkpoint, there might be names that were last updated before the final checkpoint, unless we make the checkpoint 36 kiloblocks ago. So you know what that means — we can't release it a checkpoint more recent than that. But if we do set a checkpoint that's 36 kiloblocks ago that already drops the syncup download to 66 megabytes, so that's already about tenfold improvement, so that's a good start, right, ok, how can we do better than that?

So what if we did set a checkpoint that's more recent than 36 kiloblocks? This does drop the initial syncup download to 4.9 megs. Not bad, but that means if you looking up a name whose header you haven't downloaded yet, that means you have to download 2016 headers. And that's 3.2 megabytes, and that's during the name lookup. So that's going to be a lot of extra latency for name lookups, which is going to be a massive performance problem. But can we actually improve that?

The answer is yes. So the Namecoin block headers, if you're not familiar with how merged mining works, there's actually two parts of a Namecoin block header: there's a bitcoin style block header which is 80 bytes, all the fields are the same as in Bitcoin, there's also a merged mining header, this is variable length but it's a lot bigger 10 kilobytes is not unusual. And you need both of those parts to verify the proof of work but the trick is if you have some other method to verify that the proof of work in a header is correct you don't actually need the merged mining header. And guess what a checkpoint is a perfectly valid way to do that. If a block header is committed to by a checkpoint, you can be pretty sure that the proof of work is valid for that block header.

So since the checkpoint can verify a block header without needing the merged mining header. That means we don't even have to download the merged mining header. So I patched the protocol so that it doesn't send the merged mining headers for block heights that are before the last checkpoint, and that drops the size of the on-demand set of 2016 headers from 3.2 megabytes to 323 kilobytes. Cool. Another tenfold improvement so… uh that's useful but you know 323 Kb is still kind of big if you're downloading it over Tor when you do a DNS lookup. So can we do better than that, let's see.

Well so the Electrum protocol actually has an additional checkpoint format which uses Merkle proofs. So the idea is that the client ships with a Merkle root of all the headers prior to the last checkpoint height, and then when the client asks the server: “Hey, I want to see this block blockchain header”, the server provides a Merkle branch proof when that header is requested. So you could download a single header at a time. You don't need to download an entire chunk of 2016 headers. And it still connects to the checkpoint via that Merkle proof. And Merle branch proofs if you're not familiar with Merkle branch proofs, the great thing about them is they are logarithmic in size so this scales awesome.

Now sadly I had to port this feature from Electron-Cash to Electrum, because the only implementation was in Electron-Cash, that's the BCH forking Electrum, so I did port that to Electrum and then merge to Electrum item say. But that actually worked and so now instead of 323 kilobytes to get a block header for the SPV proof now it's only under two kilobytes. So yeah that's more like it great, that we can do that with Tor.

So but what about the headers that are after the final checkpoint, these are things that are basically the headers that were mined after the software was released. So Electrum normally only downloads headers from one server at a time. Well that's pretty easy to optimize, so I patched it to download them from model as servers in parallel. Not bad that actually makes it sync a lot faster.

So Arthur also had some opinions about the impact on the final  binary size for the Tor Browser download, and he said: “Tor Browser is on the order of 60 to 80 megabytes, so adding a few megabytes is probably acceptable, but adding 10 megabytes probably gonna be too much”. The problem is all of the components of Namecoin’s Tor Browser integration that we put together crap that's 39.7 megabytes. Ok, we're gonna have to optimize that a lot.

So the first thing that I did to optimize that was just making a bunch of unneeded features toggleable at build time. So Electrum-NMC has a cute GUI, we don't need that for Tor Browser. There are plugins for hardware wallets, again Tor Browser doesn't care about, that payment protocol things which is mostly used for clocking a bitpay. Electrum-NMC is not gonna need that forth Tor Browser lots of wallet related things for likes like signing transactions, we don't need that for Tor Browser. In addition our Go related codebases specifically ncdns and dns-prop279 they had a bunch of TLS and DNS related code including things like TLS support for Chromium which Tor Browser does not care about Chromium. So all that stuff is now optional at build time and so we can just strip that out.

So if you're not familiar with Go, Go binaries are always statically linked, and the Go runtime is really huge, so we had two different Go executables, ncdns and dns-prop279, and sadly that meant a lot of stuff was getting duplicated and between those two binaries. So there were valid reasons to have the miss 2 binaries originally, but combining them into one single specialized tool. It helped us avoid that static library redundancy, so that helped a lot.

In addition… so we were using the project TorNS by meejah as dependency and that uses txtorcon which is a library that talks to the Tor control ports. And you know that makes sense, because meejah develops txtorcon obviously he'll use his library. But sadly txtorcon is very big, its dependencies were big, and so I ended up refactoring TorNS to use Stem, which is a different control port library instead of txtorcon. Stem has no additional dependencies it's generally smaller, so that helped a lot. And on that note huge kudos to Jesse Victors of Onion Name System for some example code that was very helpful for that purpose.

So how did we do on reducing the binary size? Well all that stuff got it down to 3.3 megs from the original 39.7 megs. So yeah that that's still kind of significant, but it's no longer a deal breaker, that meets the requirement that Arthur speculated would be required.

All right, so once we actually had those performance goals met, you know then we actually had to demo it for all the other Tor developers and you know get some additional approval. So we scheduled a demo and that was on April 26th of this year, Georg Koppen who was the lead Tor Browser developer at the time was there, and you know as you would expect that they were cautious but also optimistic which was great.

And by the way I want to go on a quick tangent here: Tor has an excellent review culture, at one point while I was sort of outlining what we were proposing I was asked: “Assuming you'd have to argue against including Namecoin support in Tor Browser which arguments would you bring up?” And I think this is a really good way to frame that kind of question, because it helps get developers to keep track of you know what are the downsides and trade-offs of their proposals without making it some kind of like adversarial thing. So I wish more FLOSS projects would ask that kind of question in that way. So kudos to Tor for having an awesome review culture.

Now even though they were optimistic still ever involved agreed this is this is an experiment it's not something that we are you know shipping to end-users immediately or even necessarily at all, and so as a result of scope had to be extremely narrow. So in particular that meant .bit domains will not point to IP addresses they will only point to onion services. There's no TLS, we're not going to do anything except the nightly builds, so it's not going to be in stable or alpha at least for now. It's only going to be in the new Linux version and it'll be disabled by default, so you need to use an environment variable to turn it on at least for now.

And the reason we wanted this scope to be very limited is among other things this limits the risk to end-users from introducing a bunch of new code. And because that risk is limited that means we can facilitate much faster review. And you know if the experiment goes well and we can always expand the scope later. So like all five of the scope limitations I described they could all be lifted later assuming the experiment goes well. If it doesn't go well then that's that. And in addition you know introducing all this extra code into the Tor Browser build system that does produce extra overhead for the Tor developers, and so limiting the scope limits also limits the impact it has on their workflow for just managing their codebase. And that way you know it's a given that they're not committing to keep the code there forever if they you know if they gonna get rid of it later they can strip it out pretty easily without much trouble.

So I mentioned earlier that anonymity for name owners was not going to be a short-term requirement, but we did care about anonymity for people who are viewing the websites, because this actually is a critical feature in Tor Browser users getting anonymity. So a really important subfeature is something called stream isolation which is a… it's a feature in Tor that's not very well known but it's super important. Basically it isolates traffic from different user activities on different Tor circuits, so this is what makes users anonymous in Tor rather than pseudonymous.

And unfortunately pretty much all of the pieces of code involved in the Namecoin integration needed some patching to support stream isolation properly. And this took probably two or three months of just me patching things to make that all work. There was a slight benefit though, because if you combined stream isolation and the parallelized blockchain download I mentioned for Electrum-NMC, it means you can download headers over multiple Tor circuits at once. So even if you get a single bad Tor circuit that's really slow, it won't bottleneck your blockchain download anymore. So that's a huge benefit. In addition to the Namecoin related software that needed patches I also needed to patch the Tor daemon and Firefox to actually ensure that stream isolation worked properly  with Namecoin. So yeah that would that was probably one of the most involved areas of this whole effort to be honest.

So what remained to actually get this in. Lots of code cleanup, I did an in-person meeting at the Tor meeting in Stockholm in July of 2019, integrated it into Tor Browsers build system including reproducible builds that was honestly fairly painless — Tor Browser has a great reproducible build system — so this was finally handled off to the Tor developers for review on November 11th. And after lots and lots of review cycles, and me having to address each piece of review which I did, it finally got merged to Tor Browser Nightly on December 18th. And the first Tor Browser Nightly binaries officially from Tor that have the optional Namecoin support in there were published on December 20th. So this as you might have gathered this is very recent all this stuff is hot off the press.

So if you want to try it out you can download the latest Tor Browser Nightly for the new Linux from the Tor website and run it with the environment variable TOR_ENABLE_NAMECOIN=1, and then Namecoin will be used to resolve .bit as well as .bit.onion addresses. You might be wondering why both of those suffixes, they're the same thing right now. In the future .bit might also point to IP addresses, .bit.onion will always be only onion.

So if you want to try some example domain names just to test it out these are some domain names you can try: there's a federalistpapers, onionshare, riseup and the submission systems for the Intercepts and WikiLeaks. And all of these domains are owned by our friendly Namecoin supporters right now, they're happy to donate them to the rightful owners. But since they've not been donated to the rightful owners yet, you should not rely on these for your security. So please don't submit something to WikiLeaks using this URL right now, I make no guarantee that that would be safe.

So what's next? We want to support Windows and macOS. Shouldn't be too hard, will require some refactors. Also building Python for Windows reproducibly it's gonna be a fascinating the fun adventure. We want to support Android — that's gonna be a giant rabbit hole, who knows what's there. We think we can improve the performance even more. We can cut the latency in half, cut the bandwidth in half, and cut the binary size a lot by using some fun tricks from the Go-Busybox project that u-root has created. We want to have a nice friendly GUI for registering domain names that are configured for Tor, so users select or from a drop-down menu enters the .onion domain, they don't need to construct JSON manually. We want to have anonymity for name owners even though Tor does require this from a short-term, everyone involved wants it to happen. So this will be via integration with Monero and with Bisq. Check out my 34C3 talk for details on how that would that's going to work. We want to support IP addresses not just onion services as well as we want to support TLS. We want to support operating systems like UNIX and Tails, these are currently broken because of the control port filtering, those OSS do should be fairly straightforward to fix that. We want to have some better blockchain validation and what Electrum currently does. In particularly we would like to verify the ECDSA signatures on the name transactions so not just the proof-of-work. We also want to support authenticated non-existence proofs, there's some research in the field happening now that might yield something useful there. Maybe even find a way to use full nodes with Tor Browser not totally other question, but it'll be hard. And most importantly we want feedback from the Tor community, because we don't know yet what Tor’s criteria are going to be for advancing from Nightly to Alpha or Stable, or enabling it by default. And you know the Tor devs might want something that's not on that to-do list I just gave. They may not want something that is on that list and we will honor whatever the Tor people say, because it's their browsers or not ours.

So if you want to try this out yourself I'm hosting a workshop in the Critical Decentralization Cluster workshop area, it's right after this talk. Bring a good new Linux machine you can use either a VM or bare metal and please tell me what you think this whole thing is an experiment, it's not a good experiment if you, if we don't get good feedback, so please give feedback.

I want to thank our funders for actually making this happen a NLnet foundation, Netherlands Ministry of Economic Affairs and Cyphrs — this work would not have gotten done without the funding from those entities, so huge thank you to our funders.

Here's my contact info, feel free to find me anywhere with the Congress as well, I'll be here through the end of the Congress. I've got a big Namecoin logo on my shirt, it should be really easy to find me. So thank you. Ok, do we have time for questions, let's see, or are you already giving out mic for the questions? Ok, great.

_Audience:_ What's required to run a server compatible with this, and in particular like what sense on the host header?

_Jeremy:_ Um good question. So all of the redirection that's done from the .bit to the .onion that's basically done on the transport layer. So the application layer in particular things like the host header as well as a TLS, S&I header, if you're using TLS, all of those will have the .bit domain, they will not have the .onion domain. So if you're running an onion service and you want to make sure that it works properly with Namecoin you'll need to make sure that it responds with the correct site if the host header is the .bit domain. Now for words worth in my experience almost all of the .onion services I've seen they respond with the correct .onion service regardless of what host header you send, probably because no one is expecting to see a different host headers, they're not bothering to check it. The only .onion service I've actually seen that doesn't behave that way is the DuckDuckGo .onion service. All the others I've seen will serve the same thing for anything. I couldn't catch that, um… yeah you're correct it's a it is a good idea to uh to configure them not to respond to anything you're right, but no one does that in practice. Do we have other questions? Alright looks like no additional questions, great. Thank you.

Unless Diego has questions, do you want to ask your question Diego?

_Diego:_ Jeremy how did you get to be so awesome and working on Namecoin, and how does somebody contribute to Namecoin and be as awesome with you?

_Jeremy:_ I can't comment on the being it's awesome as me thing, but in terms of if anyone wants to contribute to Namecoin and get involved in this kind of stuff, you can talk to us on our IRC channel, it's namecoin-dev on freenode, it's also mirrored to a Matrix channel, if you like Matrix, you can also email me, my email address is up there, you can also find me at the Congress and talk to me, or for that matter you can post on reddit our subreddit is our /namecoin, we also have a PHP BB forum, if you're kind of super old-school and like to talk to us that way. There's lots of ways to reach us and we would love to have more developers involved, we would love to work with more people, so yeah we're a very friendly community. We love newcomers, so yeah feel free to talk to us, if you'd like to collaborate.

_Diego:_ Alright, thanks very much Jeremy has come another round of applause.
